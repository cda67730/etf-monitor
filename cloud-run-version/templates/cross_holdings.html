<!-- templates/cross_holdings.html -->
{% extends "base.html" %}

{% block title %}跨ETF重複持股 - ETF持股明細監控系統{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-layer-group text-info"></i> 跨ETF重複持股分析</h2>
    </div>
    <div class="card-body">
        <!-- 篩選區域 -->
        <div class="filter-section">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label for="date" class="form-label">選擇日期</label>
                    <select name="date" id="date" class="form-select" onchange="this.form.submit()">
                        <option value="">請選擇日期</option>
                        {% for date in dates %}
                        <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>
                            {{ date }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="alert alert-info mb-0 w-100">
                        <small><i class="fas fa-info-circle"></i> 顯示被2個以上ETF共同持有的股票</small>
                    </div>
                </div>
            </form>
        </div>

        {% if cross_holdings %}
        <div class="cross-holdings-summary">
            <h6><i class="fas fa-chart-bar"></i> 統計概覽</h6>
            <div class="row">
                <div class="col-md-3">
                    <strong>重複持股數量：</strong> {{ cross_holdings|length }} 檔
                </div>
                <div class="col-md-3">
                    <strong>顏色說明：</strong> 
                    <span class="badge etf-badge-increase text-white">增加</span>
                    <span class="badge etf-badge-decrease text-white">減少</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">點擊「詳情」查看完整持股明細</small>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">點擊表頭可進行排序</small>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover" id="crossTable">
                <thead class="table-info">
                    <tr>
                        <th class="sortable" data-sort="stock_code" style="width: 10%;">
                            股票代碼 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th class="sortable" data-sort="stock_name" style="width: 15%;">
                            股票名稱 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th class="sortable" data-sort="etf_count" data-type="number" style="width: 10%;">
                            重複數量 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th class="sortable" data-sort="total_shares" data-type="number" style="width: 15%;">
                            總持股數 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th class="sortable" data-sort="total_increase" data-type="number" style="width: 12%;">
                            增加股數 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th class="sortable" data-sort="total_decrease" data-type="number" style="width: 12%;">
                            減少股數 <i class="fas fa-sort text-muted"></i>
                        </th>
                        <th style="width: 26%;">ETF變化明細</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holding in cross_holdings %}
                    <tr data-stock_code="{{ holding.stock_code }}"
                        data-stock_name="{{ holding.stock_name }}"
                        data-etf_count="{{ holding.etf_count }}"
                        data-total_shares="{{ holding.total_shares }}"
                        data-total_increase="{{ holding.total_increase }}"
                        data-total_decrease="{{ holding.total_decrease }}">
                        <td><strong>{{ holding.stock_code }}</strong></td>
                        <td>{{ holding.stock_name }}</td>
                        <td>
                            <span class="badge bg-info">{{ holding.etf_count }} 個ETF</span>
                        </td>
                        <td>{{ "{:,}".format(holding.total_shares) }}</td>
                        <td>
                            {% if holding.total_increase > 0 %}
                            <span class="change-increase">+{{ "{:,}".format(holding.total_increase) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if holding.total_decrease > 0 %}
                            <span class="change-decrease">-{{ "{:,}".format(holding.total_decrease) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                {% for etf in holding.etf_details %}
                                    {% if etf.change != 0 %}
                                        {% if etf.change > 0 %}
                                        <span class="badge etf-badge-increase text-white" title="增加 {{ '{:,}'.format(etf.change) }} 股">
                                            {{ etf.etf_code }} +{{ "{:,}".format(etf.change) }}
                                        </span>
                                        {% elif etf.change < 0 %}
                                        <span class="badge etf-badge-decrease text-white" title="減少 {{ '{:,}'.format(etf.change|abs) }} 股">
                                            {{ etf.etf_code }} {{ "{:,}".format(etf.change) }}
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- 詳細信息按鈕 -->
                            <button class="btn btn-sm btn-outline-info mt-1" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#detail-{{ holding.stock_code }}" 
                                    aria-expanded="false">
                                <i class="fas fa-info-circle"></i> 詳情
                            </button>
                            
                            <!-- 展開的詳細信息 -->
                            <div class="collapse mt-2" id="detail-{{ holding.stock_code }}">
                                <div class="card card-body bg-light">
                                    <small>
                                        <table class="table table-sm table-borderless mb-0">
                                            <thead>
                                                <tr class="text-muted">
                                                    <th>ETF</th>
                                                    <th>ETF名稱</th>
                                                    <th>現持股</th>
                                                    <th>前持股</th>
                                                    <th>權重</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for etf in holding.etf_details %}
                                                <tr>
                                                    <td>{{ etf.etf_code }}</td>
                                                    <td><small>{{ etf.etf_name }}</small></td>
                                                    <td>{{ "{:,}".format(etf.shares) }}</td>
                                                    <td>{{ "{:,}".format(etf.previous_shares) }}</td>
                                                    <td>{{ "%.2f"|format(etf.weight) }}%</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </small>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <small class="text-muted">
                總計：{{ cross_holdings|length }} 檔重複持股
                {% if selected_date %} | 日期：{{ selected_date }}{% endif %}
            </small>
        </div>
        
        {% elif selected_date %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> {{ selected_date }} 當日無跨ETF重複持股
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 請選擇日期以查看跨ETF重複持股分析
        </div>
        {% endif %}
    </div>
</div>

<!-- 添加自定義樣式 -->
<style>
.change-increase { 
    color: #dc3545; 
    font-weight: bold;
}
.change-decrease { 
    color: #28a745; 
    font-weight: bold;
}
.etf-badge-increase {
    background-color: #dc3545 !important;
}
.etf-badge-decrease {
    background-color: #28a745 !important;
}
.cross-holdings-summary {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 10px;
    margin-bottom: 10px;
}
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}
.sortable:hover {
    background-color: rgba(0,0,0,.075);
}
.sortable.sort-asc i {
    color: #28a745 !important;
}
.sortable.sort-desc i {
    color: #dc3545 !important;
}
.sortable.sort-asc i:before {
    content: "\f0de";
}
.sortable.sort-desc i:before {
    content: "\f0dd";
}
</style>

<!-- 排序功能JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('crossTable');
    if (!table) return;
    
    const headers = table.querySelectorAll('.sortable');
    let currentSort = { column: null, direction: 'asc' };
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const type = this.dataset.type || 'string';
            
            // 更新排序方向
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'asc';
            }
            currentSort.column = column;
            
            // 更新表頭樣式
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            this.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // 排序表格
            sortTable(column, type, currentSort.direction);
        });
    });
    
    function sortTable(column, type, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal = a.dataset[column];
            let bVal = b.dataset[column];
            
            // 處理數字類型
            if (type === 'number') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else {
                aVal = aVal.toString().toLowerCase();
                bVal = bVal.toString().toLowerCase();
            }
            
            let result = 0;
            if (aVal < bVal) result = -1;
            if (aVal > bVal) result = 1;
            
            return direction === 'desc' ? -result : result;
        });
        
        // 重新插入排序後的行
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // 默認按總持股數降序排序
    const totalSharesHeader = table.querySelector('[data-sort="total_shares"]');
    if (totalSharesHeader) {
        totalSharesHeader.click();
        setTimeout(() => totalSharesHeader.click(), 100); // 點擊兩次變成降序
    }
});
</script>
{% endblock %}